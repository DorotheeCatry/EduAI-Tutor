{% extends 'core/base.html' %}
{% load static %}

{% block title %}{{ generated_course.title|default:"Cours généré" }} - EduAI Tutor{% endblock %}

{% block content %}
<div class="p-6 space-y-6 h-full overflow-auto">
    <!-- Header du cours -->
    <div class="flex items-center justify-between">
        <div class="flex items-center space-x-4">
            <div class="w-12 h-12 bg-primary-green rounded-lg flex items-center justify-center">
                <i data-lucide="book-open" class="w-6 h-6 text-white"></i>
            </div>
            <div>
                <h1 class="text-2xl font-bold text-white">
                    {% if generated_course %}
                        {{ generated_course.title }}
                    {% else %}
                        {{ course.title }}
                    {% endif %}
                </h1>
                {% if generated_course and generated_course.module_name and generated_course.module != 'general' %}
                    <p class="text-sm text-gray-400">{{ generated_course.module_name }}</p>
                {% endif %}
            </div>
        </div>
        
        <!-- Actions rapides -->
        <div class="flex items-center space-x-3">
            {% if generated_course %}
                <form method="post" action="{% url 'courses:save' %}" class="inline">
                    {% csrf_token %}
                    <input type="hidden" name="title" value="{{ generated_course.title }}">
                    <input type="hidden" name="topic" value="{{ generated_course.topic }}">
                    <input type="hidden" name="module" value="{{ generated_course.module }}">
                    <input type="hidden" name="content" value="{{ generated_course.content }}">
                    
                    <button type="submit" class="px-4 py-2 bg-primary-blue text-white rounded-lg hover:bg-blue-600 transition-colors flex items-center space-x-2">
                        <i data-lucide="save" class="w-4 h-4"></i>
                        <span>Sauvegarder</span>
                    </button>
                </form>
                
                <a href="{% url 'quiz:start' %}?topic={{ generated_course.topic }}" class="px-4 py-2 bg-primary-rose text-white rounded-lg hover:bg-pink-600 transition-colors flex items-center space-x-2">
                    <i data-lucide="brain" class="w-4 h-4"></i>
                    <span>Quiz</span>
                </a>
            {% endif %}
            
            <a href="{% url 'courses:generator' %}" class="px-4 py-2 bg-gray-700 text-white rounded-lg hover:bg-gray-600 transition-colors flex items-center space-x-2">
                <i data-lucide="arrow-left" class="w-4 h-4"></i>
                <span>Retour</span>
            </a>
        </div>
    </div>

    {% if error %}
        <div class="bg-red-500 bg-opacity-20 border border-red-500 border-opacity-30 rounded-lg p-4">
            <div class="flex items-center space-x-2">
                <i data-lucide="alert-circle" class="w-5 h-5 text-red-400"></i>
                <span class="text-red-400 font-medium">Erreur</span>
            </div>
            <p class="text-red-300 mt-2">{{ error }}</p>
        </div>
    {% endif %}

    <!-- Contenu du cours - EXACTEMENT comme le chat -->
    {% if generated_course %}
        <div class="bg-gray-800 rounded-lg border border-gray-700 p-6">
            <div class="text-sm leading-relaxed" id="course-content">
                {{ generated_course.content|linebreaks }}
            </div>
        </div>
    {% endif %}
</div>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        lucide.createIcons();
        
        // EXACTEMENT la même fonction que le chat
        function formatResponse(text) {
            let formatted = text
                // Headers
                .replace(/^### (.*$)/gm, '<h3 class="text-primary-blue font-bold text-base mb-2 mt-3">$1</h3>')
                .replace(/^## (.*$)/gm, '<h2 class="text-primary-green font-bold text-lg mb-2 mt-3">$1</h2>')
                .replace(/^# (.*$)/gm, '<h1 class="text-white font-bold text-xl mb-3 mt-4">$1</h1>')
                
                // Code blocks
                .replace(/```(\w+)?\n?([\s\S]*?)```/g, function(match, lang, code) {
                    const language = lang || 'code';
                    return `<div class="code-block-container my-3">
                        <div class="code-header">
                            <span class="code-language">${language}</span>
                            <button class="copy-btn" onclick="copyCode(this)">
                                <i data-lucide="copy" class="w-3 h-3"></i>
                                <span>Copy</span>
                            </button>
                        </div>
                        <pre class="code-content"><code>${escapeHtml(code.trim())}</code></pre>
                    </div>`;
                })
                
                // Inline code
                .replace(/`([^`\n]+)`/g, '<code class="inline-code">$1</code>')
                
                // Bold text
                .replace(/\*\*(.*?)\*\*/g, '<strong class="keyword-highlight">$1</strong>')
                
                // Lists
                .replace(/^[\-\*] (.+)$/gm, '<li class="list-item">$1</li>')
                
                // Line breaks
                .replace(/\n\n/g, '</p><p class="mb-2">')
                .replace(/\n/g, '<br>');

            // Wrap in paragraphs
            formatted = '<p class="mb-2">' + formatted + '</p>';
            
            // Group list items
            formatted = formatted.replace(/(<li class="list-item">.*?<\/li>)/gs, function(match) {
                return '<ul class="list-container">' + match + '</ul>';
            });

            return formatted;
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
        
        // Appliquer le formatage
        const content = document.getElementById('course-content');
        if (content) {
            content.innerHTML = formatResponse(content.textContent);
            lucide.createIcons();
        }
        
        // Fonction pour copier le code
        window.copyCode = function(button) {
            const codeContainer = button.closest('.code-block-container');
            const codeElement = codeContainer.querySelector('code');
            const text = codeElement.textContent;
            
            navigator.clipboard.writeText(text).then(() => {
                const icon = button.querySelector('i');
                const span = button.querySelector('span');
                const originalIcon = icon.getAttribute('data-lucide');
                const originalText = span.textContent;
                
                button.classList.add('copied');
                icon.setAttribute('data-lucide', 'check');
                span.textContent = 'Copied!';
                
                lucide.createIcons();
                
                setTimeout(() => {
                    button.classList.remove('copied');
                    icon.setAttribute('data-lucide', originalIcon);
                    span.textContent = originalText;
                    lucide.createIcons();
                }, 2000);
            }).catch(err => {
                console.error('Erreur lors de la copie:', err);
            });
        };
    });
</script>

<style>
/* EXACTEMENT les mêmes styles que le chat */
.keyword-highlight {
    background: linear-gradient(135deg, #4CAF50, #45a049);
    color: #FFFFFF;
    padding: 0.125rem 0.375rem;
    border-radius: 0.25rem;
    font-weight: 600;
    font-size: 0.9em;
}

.inline-code {
    background: #0D1117;
    color: #79C0FF;
    padding: 0.125rem 0.375rem;
    border-radius: 0.25rem;
    font-family: 'SF Mono', Monaco, 'Cascadia Code', monospace;
    font-size: 0.875rem;
    border: 1px solid #30363D;
}

.code-block-container {
    background: #0D1117;
    border: 1px solid #30363D;
    border-radius: 0.5rem;
    overflow: hidden;
    margin: 0.75rem 0;
}

.code-header {
    background: #21262D;
    padding: 0.75rem 1rem;
    border-bottom: 1px solid #30363D;
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.code-language {
    font-size: 0.75rem;
    color: #7C3AED;
    background: #1E1B4B;
    padding: 0.25rem 0.5rem;
    border-radius: 0.25rem;
    font-family: 'SF Mono', Monaco, 'Cascadia Code', monospace;
    font-weight: 600;
}

.copy-btn {
    display: flex;
    align-items: center;
    gap: 0.375rem;
    background: #374151;
    color: #9CA3AF;
    border: none;
    padding: 0.375rem 0.75rem;
    border-radius: 0.375rem;
    font-size: 0.75rem;
    cursor: pointer;
    transition: all 0.2s ease;
    font-weight: 500;
}

.copy-btn:hover {
    background: #4B5563;
    color: #FFFFFF;
    transform: translateY(-1px);
}

.copy-btn.copied {
    background: #4CAF50;
    color: #FFFFFF;
}

.code-content {
    padding: 1rem;
    margin: 0;
    background: #0D1117;
    color: #E6EDF3;
    font-family: 'SF Mono', Monaco, 'Cascadia Code', monospace;
    font-size: 0.875rem;
    line-height: 1.5;
    overflow-x: auto;
}

.list-container {
    margin: 0.5rem 0;
    padding-left: 1rem;
}

.list-item {
    position: relative;
    margin-bottom: 0.25rem;
    color: #E5E7EB;
    line-height: 1.6;
}

.list-item::before {
    content: "•";
    color: #4CAF50;
    font-weight: bold;
    position: absolute;
    left: -1rem;
}

/* Responsive design */
@media (max-width: 768px) {
    .code-block-container {
        margin-left: -1rem;
        margin-right: -1rem;
        border-radius: 0;
    }
}
</style>
{% endblock %}