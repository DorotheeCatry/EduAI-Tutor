{% extends 'core/base.html' %}
{% load static %}

{% block title %}{{ generated_course.title|default:"Cours généré" }} - EduAI Tutor{% endblock %}

{% block content %}
<div class="p-6 space-y-6 h-full overflow-auto">
    <!-- Header du cours -->
    <div class="flex items-center justify-between mb-6">
        <div class="flex items-center space-x-4">
            <div class="w-12 h-12 bg-primary-green rounded-lg flex items-center justify-center">
                <i data-lucide="book-open" class="w-6 h-6 text-white"></i>
            </div>
            <div>
                <h1 class="text-2xl font-bold text-white">
                    {% if generated_course %}
                        {{ generated_course.title }}
                    {% else %}
                        {{ course.title }}
                    {% endif %}
                </h1>
                {% if generated_course and generated_course.module_name and generated_course.module != 'general' %}
                    <p class="text-sm text-gray-400">{{ generated_course.module_name }}</p>
                {% endif %}
            </div>
        </div>
        
        <!-- Actions rapides -->
        <div class="flex items-center space-x-3">
            {% if generated_course %}
                <form method="post" action="{% url 'courses:save' %}" class="inline">
                    {% csrf_token %}
                    <input type="hidden" name="title" value="{{ generated_course.title }}">
                    <input type="hidden" name="topic" value="{{ generated_course.topic }}">
                    <input type="hidden" name="module" value="{{ generated_course.module }}">
                    <input type="hidden" name="content" value="{{ generated_course.content }}">
                    
                    <button type="submit" class="px-4 py-2 bg-primary-blue text-white rounded-lg hover:bg-blue-600 transition-colors flex items-center space-x-2">
                        <i data-lucide="save" class="w-4 h-4"></i>
                        <span>Sauvegarder</span>
                    </button>
                </form>
                
                <a href="{% url 'quiz:start' %}?topic={{ generated_course.topic }}" class="px-4 py-2 bg-primary-rose text-white rounded-lg hover:bg-pink-600 transition-colors flex items-center space-x-2">
                    <i data-lucide="brain" class="w-4 h-4"></i>
                    <span>Quiz</span>
                </a>
            {% endif %}
            
            <a href="{% url 'courses:generator' %}" class="px-4 py-2 bg-gray-700 text-white rounded-lg hover:bg-gray-600 transition-colors flex items-center space-x-2">
                <i data-lucide="arrow-left" class="w-4 h-4"></i>
                <span>Retour</span>
            </a>
        </div>
    </div>

    {% if error %}
        <div class="bg-red-500 bg-opacity-20 border border-red-500 border-opacity-30 rounded-lg p-4 mb-6">
            <div class="flex items-center space-x-2">
                <i data-lucide="alert-circle" class="w-5 h-5 text-red-400"></i>
                <span class="text-red-400 font-medium">Erreur</span>
            </div>
            <p class="text-red-300 mt-2">{{ error }}</p>
        </div>
    {% endif %}

    <!-- Options de personnalisation après génération -->
    {% if generated_course %}
        <div class="bg-gray-800 rounded-lg p-4 border border-gray-700 mb-6">
            <div class="flex items-center justify-between">
                <div class="flex items-center space-x-3">
                    <i data-lucide="settings" class="w-5 h-5 text-primary-blue"></i>
                    <span class="text-white font-medium">Personnaliser ce cours</span>
                </div>
                <div class="flex items-center space-x-2">
                    <button onclick="customizeCourse('complexity')" class="px-3 py-1 bg-primary-green text-white rounded text-sm hover:bg-green-600 transition-colors">
                        <i data-lucide="trending-up" class="w-4 h-4 inline mr-1"></i>
                        Plus complexe
                    </button>
                    <button onclick="customizeCourse('examples')" class="px-3 py-1 bg-primary-blue text-white rounded text-sm hover:bg-blue-600 transition-colors">
                        <i data-lucide="code" class="w-4 h-4 inline mr-1"></i>
                        Plus d'exemples
                    </button>
                    <button onclick="customizeCourse('exercises')" class="px-3 py-1 bg-primary-rose text-white rounded text-sm hover:bg-pink-600 transition-colors">
                        <i data-lucide="dumbbell" class="w-4 h-4 inline mr-1"></i>
                        Plus d'exercices
                    </button>
                    <button onclick="customizeCourse('simplify')" class="px-3 py-1 bg-gray-600 text-white rounded text-sm hover:bg-gray-500 transition-colors">
                        <i data-lucide="trending-down" class="w-4 h-4 inline mr-1"></i>
                        Simplifier
                    </button>
                </div>
            </div>
        </div>
    {% endif %}

    <!-- Contenu du cours -->
    {% if generated_course %}
        <div class="bg-gray-800 rounded-lg border border-gray-700 overflow-hidden">
            <div class="p-6">
                <div class="prose prose-invert max-w-none" id="course-content">
                    {{ generated_course.content|safe }}
                </div>
            </div>
        </div>
    {% endif %}
</div>

<!-- Modal de personnalisation -->
<div id="customization-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50 flex items-center justify-center">
    <div class="bg-gray-800 rounded-lg p-6 max-w-md w-full mx-4 border border-gray-700">
        <div class="flex items-center justify-between mb-4">
            <h3 class="text-lg font-bold text-white" id="modal-title">Personnaliser le cours</h3>
            <button onclick="closeCustomizationModal()" class="text-gray-400 hover:text-white">
                <i data-lucide="x" class="w-5 h-5"></i>
            </button>
        </div>
        <div class="mb-4">
            <p class="text-gray-300 text-sm" id="modal-description">Décrivez comment vous souhaitez adapter ce cours...</p>
            <textarea id="customization-input" rows="3" placeholder="Ex: Ajouter plus d'exemples pratiques avec des cas d'usage réels..." 
                      class="w-full mt-2 px-3 py-2 text-sm bg-gray-900 border border-gray-600 rounded-lg text-white placeholder-gray-400 focus:outline-none focus:border-primary-green focus:ring-1 focus:ring-primary-green transition-colors resize-none"></textarea>
        </div>
        <div class="flex justify-end space-x-3">
            <button onclick="closeCustomizationModal()" class="px-4 py-2 bg-gray-600 text-white rounded-lg hover:bg-gray-500 transition-colors">
                Annuler
            </button>
            <button onclick="applyCustomization()" class="px-4 py-2 bg-primary-green text-white rounded-lg hover:bg-green-600 transition-colors">
                <i data-lucide="wand-2" class="w-4 h-4 inline mr-1"></i>
                Appliquer
            </button>
        </div>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        lucide.createIcons();
        
        // Fonction pour formater le contenu markdown (même que le chat)
        function formatMarkdownContent() {
            const content = document.getElementById('course-content');
            if (!content) return;
            
            let html = content.innerHTML;
            
            // Headers avec emojis et couleurs
            html = html.replace(/^# (.*$)/gm, '<h1 class="text-3xl font-bold text-white mb-6 mt-8 first:mt-0 flex items-center">$1</h1>');
            html = html.replace(/^## (.*$)/gm, '<h2 class="text-2xl font-bold text-primary-green mb-4 mt-6 flex items-center">$1</h2>');
            html = html.replace(/^### (.*$)/gm, '<h3 class="text-xl font-bold text-primary-blue mb-3 mt-5">$1</h3>');
            
            // Blocs de code avec header repositionné
            html = html.replace(/```(\w+)?\n?([\s\S]*?)```/g, function(match, lang, code) {
                const language = lang || 'code';
                return `<div class="code-block-container my-4">
                    <div class="code-header">
                        <span class="code-language">${language}</span>
                        <button class="copy-btn" onclick="copyCode(this)">
                            <i data-lucide="copy" class="w-4 h-4"></i>
                            <span>Copy</span>
                        </button>
                    </div>
                    <pre class="code-content"><code>${escapeHtml(code.trim())}</code></pre>
                </div>`;
            });
            
            // Code inline
            html = html.replace(/`([^`\n]+)`/g, '<code class="inline-code">$1</code>');
            
            // Texte en gras avec surlignage
            html = html.replace(/\*\*(.*?)\*\*/g, '<strong class="keyword-highlight">$1</strong>');
            
            // Listes à puces
            html = html.replace(/^- (.+)$/gm, '<li class="list-item">$1</li>');
            html = html.replace(/^• (.+)$/gm, '<li class="list-item">$1</li>');
            
            // Grouper les listes
            html = html.replace(/(<li class="list-item">.*?<\/li>)/gs, function(match) {
                return '<ul class="list-container mb-4">' + match + '</ul>';
            });
            
            // Paragraphes
            html = html.replace(/\n\n/g, '</p><p class="mb-4 text-gray-300 leading-relaxed">');
            html = '<p class="mb-4 text-gray-300 leading-relaxed">' + html + '</p>';
            
            content.innerHTML = html;
            lucide.createIcons();
        }
        
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
        
        // Fonction pour copier le code
        window.copyCode = function(button) {
            const codeContainer = button.closest('.code-block-container');
            const codeElement = codeContainer.querySelector('code');
            const text = codeElement.textContent;
            
            navigator.clipboard.writeText(text).then(() => {
                const icon = button.querySelector('i');
                const span = button.querySelector('span');
                const originalIcon = icon.getAttribute('data-lucide');
                const originalText = span.textContent;
                
                button.classList.add('copied');
                icon.setAttribute('data-lucide', 'check');
                span.textContent = 'Copied!';
                
                lucide.createIcons();
                
                setTimeout(() => {
                    button.classList.remove('copied');
                    icon.setAttribute('data-lucide', originalIcon);
                    span.textContent = originalText;
                    lucide.createIcons();
                }, 2000);
            }).catch(err => {
                console.error('Erreur lors de la copie:', err);
            });
        };
        
        // Appliquer le formatage
        formatMarkdownContent();
    });

    let currentCustomizationType = '';

    function customizeCourse(type) {
        currentCustomizationType = type;
        const modal = document.getElementById('customization-modal');
        const title = document.getElementById('modal-title');
        const description = document.getElementById('modal-description');
        const input = document.getElementById('customization-input');
        
        const customizations = {
            'complexity': {
                title: 'Rendre plus complexe',
                description: 'Comment souhaitez-vous augmenter la complexité de ce cours ?',
                placeholder: 'Ex: Ajouter des concepts avancés, des détails techniques approfondis...'
            },
            'examples': {
                title: 'Ajouter des exemples',
                description: 'Quels types d\'exemples souhaitez-vous ajouter ?',
                placeholder: 'Ex: Plus d\'exemples pratiques, cas d\'usage réels, projets concrets...'
            },
            'exercises': {
                title: 'Ajouter des exercices',
                description: 'Quels exercices souhaitez-vous ajouter ?',
                placeholder: 'Ex: Exercices pratiques, défis de codage, projets à réaliser...'
            },
            'simplify': {
                title: 'Simplifier le cours',
                description: 'Comment souhaitez-vous simplifier ce cours ?',
                placeholder: 'Ex: Expliquer plus simplement, réduire la complexité, ajouter plus d\'explications...'
            }
        };
        
        const config = customizations[type];
        title.textContent = config.title;
        description.textContent = config.description;
        input.placeholder = config.placeholder;
        input.value = '';
        
        modal.classList.remove('hidden');
        input.focus();
    }

    function closeCustomizationModal() {
        document.getElementById('customization-modal').classList.add('hidden');
    }

    function applyCustomization() {
        const input = document.getElementById('customization-input');
        const customization = input.value.trim();
        
        if (!customization) {
            alert('Veuillez décrire la personnalisation souhaitée');
            return;
        }
        
        // Ici on enverrait la demande de personnalisation au backend
        console.log('Personnalisation:', currentCustomizationType, customization);
        
        // Pour l'instant, on ferme juste le modal
        closeCustomizationModal();
        
        // TODO: Implémenter l'appel AJAX pour personnaliser le cours
        alert('Fonctionnalité de personnalisation en cours de développement...');
    }

    // Fermer le modal en cliquant à l'extérieur
    document.getElementById('customization-modal').addEventListener('click', function(e) {
        if (e.target === this) {
            closeCustomizationModal();
        }
    });
</script>

<style>
/* Styles pour le formatage du contenu (même que le chat) */
.keyword-highlight {
    background: linear-gradient(135deg, #4CAF50, #45a049);
    color: #FFFFFF;
    padding: 0.125rem 0.375rem;
    border-radius: 0.25rem;
    font-weight: 600;
    font-size: 0.9em;
}

.inline-code {
    background: #0D1117;
    color: #79C0FF;
    padding: 0.125rem 0.375rem;
    border-radius: 0.25rem;
    font-family: 'SF Mono', Monaco, 'Cascadia Code', monospace;
    font-size: 0.875rem;
    border: 1px solid #30363D;
}

.code-block-container {
    background: #0D1117;
    border: 1px solid #30363D;
    border-radius: 0.5rem;
    overflow: hidden;
    margin: 1rem 0;
}

.code-header {
    background: #21262D;
    padding: 0.75rem 1rem;
    border-bottom: 1px solid #30363D;
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.code-language {
    font-size: 0.75rem;
    color: #7C3AED;
    background: #1E1B4B;
    padding: 0.25rem 0.5rem;
    border-radius: 0.25rem;
    font-family: 'SF Mono', Monaco, 'Cascadia Code', monospace;
    font-weight: 600;
}

.copy-btn {
    display: flex;
    align-items: center;
    gap: 0.375rem;
    background: #374151;
    color: #9CA3AF;
    border: none;
    padding: 0.375rem 0.75rem;
    border-radius: 0.375rem;
    font-size: 0.75rem;
    cursor: pointer;
    transition: all 0.2s ease;
    font-weight: 500;
}

.copy-btn:hover {
    background: #4B5563;
    color: #FFFFFF;
    transform: translateY(-1px);
}

.copy-btn.copied {
    background: #4CAF50;
    color: #FFFFFF;
}

.code-content {
    padding: 1rem;
    margin: 0;
    background: #0D1117;
    color: #E6EDF3;
    font-family: 'SF Mono', Monaco, 'Cascadia Code', monospace;
    font-size: 0.875rem;
    line-height: 1.5;
    overflow-x: auto;
}

.list-container {
    margin: 0.5rem 0;
    padding-left: 1rem;
}

.list-item {
    position: relative;
    margin-bottom: 0.5rem;
    color: #E5E7EB;
    line-height: 1.6;
}

.list-item::before {
    content: "•";
    color: #4CAF50;
    font-weight: bold;
    position: absolute;
    left: -1rem;
}

/* Responsive design */
@media (max-width: 768px) {
    .code-block-container {
        margin-left: -1rem;
        margin-right: -1rem;
        border-radius: 0;
    }
}
</style>
{% endblock %}