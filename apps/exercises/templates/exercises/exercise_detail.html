{% extends 'base.html' %}

{% block title %}{{ exercise.title }} - Exercices Python{% endblock %}

{% block extra_head %}
<!-- Monaco Editor -->
<script src="https://unpkg.com/monaco-editor@0.44.0/min/vs/loader.js"></script>
{% endblock %}

{% block content %}
<div class="flex h-full overflow-hidden">
    <!-- Panneau de gauche - √ânonc√© -->
    <div class="w-1/2 bg-gray-800 border-r border-gray-700 flex flex-col">
        <!-- Header -->
        <div class="p-6 border-b border-gray-700 flex-shrink-0">
            <div class="flex items-center justify-between mb-4">
                <div class="flex items-center space-x-3">
                    <a href="{% url 'exercises:list' %}" class="text-gray-400 hover:text-white transition-colors">
                        <i data-lucide="arrow-left" class="w-5 h-5"></i>
                    </a>
                    <h1 class="text-xl font-bold text-white">{{ exercise.title }}</h1>
                </div>
                
                <div class="flex items-center space-x-2">
                    {% if exercise.difficulty == 'beginner' %}
                        <span class="px-3 py-1 bg-green-500/20 text-green-400 rounded-full text-sm font-medium">D√©butant</span>
                    {% elif exercise.difficulty == 'intermediate' %}
                        <span class="px-3 py-1 bg-yellow-500/20 text-yellow-400 rounded-full text-sm font-medium">Interm√©diaire</span>
                    {% else %}
                        <span class="px-3 py-1 bg-red-500/20 text-red-400 rounded-full text-sm font-medium">Avanc√©</span>
                    {% endif %}
                    
                    {% if progress.is_completed %}
                        <span class="px-3 py-1 bg-primary-green/20 text-primary-green rounded-full text-sm font-medium flex items-center space-x-1">
                            <i data-lucide="check" class="w-3 h-3"></i>
                            <span>Compl√©t√©</span>
                        </span>
                    {% endif %}
                </div>
            </div>
            
            <div class="flex items-center space-x-4 text-sm text-gray-400">
                <span class="flex items-center space-x-1">
                    <i data-lucide="tag" class="w-4 h-4"></i>
                    <span>{{ exercise.topic|title }}</span>
                </span>
                <span class="flex items-center space-x-1">
                    <i data-lucide="clock" class="w-4 h-4"></i>
                    <span>{{ progress.attempts_count }} tentative{{ progress.attempts_count|pluralize }}</span>
                </span>
            </div>
        </div>
        
        <!-- Description -->
        <div class="flex-1 overflow-y-auto p-6">
            <div class="prose prose-invert max-w-none">
                <h3 class="text-lg font-bold text-white mb-4">üìã √ânonc√©</h3>
                <div class="text-gray-300 leading-relaxed mb-6">
                    {{ exercise.description|linebreaks }}
                </div>
                
                <!-- Tests √† passer -->
                <h3 class="text-lg font-bold text-white mb-4">üß™ Tests √† passer</h3>
                <div class="space-y-3" id="tests-display">
                    {% for test in exercise.tests %}
                        <div class="bg-gray-900 rounded-lg p-4 border border-gray-600 test-case" data-test-index="{{ forloop.counter0 }}">
                            <div class="flex items-center justify-between">
                                <div class="flex items-center space-x-3">
                                    <div class="test-status w-6 h-6 rounded-full bg-gray-600 flex items-center justify-center">
                                        <span class="text-xs font-bold text-gray-400">{{ forloop.counter }}</span>
                                    </div>
                                    <div>
                                        <code class="text-primary-blue text-sm">{{ test.input }}</code>
                                        <div class="text-xs text-gray-500 mt-1">Attendu: <code class="text-primary-green">{{ test.expected }}</code></div>
                                    </div>
                                </div>
                                <div class="test-result hidden">
                                    <div class="text-xs text-gray-400">Obtenu: <code class="test-actual"></code></div>
                                </div>
                            </div>
                        </div>
                    {% endfor %}
                </div>
                
                <!-- Soumissions r√©centes -->
                {% if recent_submissions %}
                    <h3 class="text-lg font-bold text-white mb-4 mt-8">üìä Tentatives r√©centes</h3>
                    <div class="space-y-2">
                        {% for submission in recent_submissions %}
                            <div class="bg-gray-900 rounded-lg p-3 border border-gray-600 flex items-center justify-between">
                                <div class="flex items-center space-x-3">
                                    {% if submission.status == 'success' %}
                                        <i data-lucide="check-circle" class="w-4 h-4 text-green-400"></i>
                                        <span class="text-green-400 text-sm">R√©ussi</span>
                                    {% else %}
                                        <i data-lucide="x-circle" class="w-4 h-4 text-red-400"></i>
                                        <span class="text-red-400 text-sm">√âchou√©</span>
                                    {% endif %}
                                    <span class="text-gray-400 text-sm">{{ submission.passed_tests_count }}/{{ submission.total_tests_count }} tests</span>
                                </div>
                                <span class="text-gray-500 text-xs">{{ submission.submitted_at|timesince }}</span>
                            </div>
                        {% endfor %}
                    </div>
                {% endif %}
            </div>
        </div>
    </div>
    
    <!-- Panneau de droite - √âditeur de code -->
    <div class="w-1/2 bg-gray-900 flex flex-col">
        <!-- Header √©diteur -->
        <div class="p-6 border-b border-gray-700 flex items-center justify-between flex-shrink-0 bg-gray-800">
            <div class="flex items-center space-x-3">
                <i data-lucide="code" class="w-5 h-5 text-primary-green"></i>
                <div>
                    <span class="text-white font-semibold">√âditeur Python</span>
                    <div class="text-xs text-gray-400">√âcrivez votre solution ici</div>
                </div>
            </div>
            
            <div class="flex items-center space-x-3">
                <button id="reset-code" class="px-4 py-2 text-sm bg-gray-700 text-white rounded-lg hover:bg-gray-600 transition-colors flex items-center space-x-2">
                    <i data-lucide="rotate-ccw" class="w-4 h-4"></i>
                    <span>Reset</span>
                </button>
                
                <button id="run-code" class="px-6 py-2 text-sm bg-primary-green text-white rounded-lg hover:bg-green-600 transition-colors flex items-center space-x-2 font-medium shadow-lg">
                    <i data-lucide="play" class="w-4 h-4"></i>
                    <span>Tester le code</span>
                </button>
            </div>
        </div>
        
        <!-- √âditeur Monaco -->
        <div class="flex-1 relative bg-[#1e1e1e] min-h-0">
            <!-- Container pour Monaco avec fallback imm√©diat -->
            <div id="editor-container" class="w-full h-full relative">
                <!-- Fallback textarea toujours pr√©sent -->
                <textarea 
                    id="code-editor" 
                    class="w-full h-full bg-[#1e1e1e] text-white font-mono text-sm p-4 border-none outline-none resize-none"
                    style="font-family: 'JetBrains Mono', 'Fira Code', 'SF Mono', Monaco, 'Cascadia Code', monospace; line-height: 1.6; tab-size: 4;"
                    placeholder="√âcrivez votre code Python ici..."
                    spellcheck="false"
                >{{ exercise.starter_code }}</textarea>
                
                <!-- Monaco container (sera cr√©√© par JS si disponible) -->
                <div id="monaco-editor" class="absolute inset-0 hidden"></div>
            </div>
        </div>
        
        <!-- R√©sultats -->
        <div id="results-panel" class="border-t border-gray-700 bg-gray-800 hidden">
            <div class="p-4">
                <div id="results-content"></div>
            </div>
        </div>
    </div>
</div>

<script src="https://unpkg.com/monaco-editor@0.44.0/min/vs/loader.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function () {
    lucide.createIcons();
    console.log('üöÄ Page charg√©e, initialisation...');

    const starterCode = `{{ exercise.starter_code|escapejs }}`;
    const textArea = document.getElementById('code-editor');
    const runBtn = document.getElementById('run-code');
    const resetBtn = document.getElementById('reset-code');
    let editor = null;

    // Initialiser Monaco Editor
    require.config({ paths: { 'vs': 'https://unpkg.com/monaco-editor@0.44.0/min/vs' }});
    require(['vs/editor/editor.main'], function () {
        console.log('üé® Monaco charg√©');
        const monacoContainer = document.getElementById('monaco-editor');

        editor = monaco.editor.create(monacoContainer, {
            value: textArea.value || starterCode,
            language: 'python',
            theme: 'vs-dark',
            fontSize: 14,
            fontFamily: 'JetBrains Mono, Fira Code, monospace',
            automaticLayout: true,
            minimap: { enabled: false },
            scrollBeyondLastLine: false,
            padding: {
                top: 12,  // ou 16 si tu veux plus d'air
                bottom: 12
            }
        });

                // üéØ Animer les tests un par un
                await animateTestResults(data.test_results);
                
                // üéâ Afficher les r√©sultats finaux avec points
        // Masquer textarea et afficher Monaco
        textArea.style.display = 'none';
        monacoContainer.classList.remove('hidden');
        console.log('‚úÖ Monaco Editor initialis√©');

        // Mettre le focus sur l‚Äô√©diteur
        editor.focus();

        // üîÑ Reset du code
        resetBtn.addEventListener('click', function () {
            console.log('üîÑ Reset cliqu√©');
            if (confirm('√ätes-vous s√ªr de vouloir r√©initialiser le code ?')) {
                editor.setValue(starterCode);
                editor.focus();
                console.log('‚úÖ Code r√©initialis√©');
            }
        });

        // ‚ñ∂Ô∏è Ex√©cution du code
        runBtn.addEventListener('click', async function () {
            console.log('‚ñ∂Ô∏è Bouton Tester cliqu√©');
            const code = editor.getValue().trim();

            if (!code) {
                alert('Veuillez √©crire du code avant de tester.');
                return;
            }

            // Copier le code dans le textarea pour Django si n√©cessaire
            textArea.value = code;

            const originalContent = runBtn.innerHTML;
            runBtn.disabled = true;
            runBtn.innerHTML = '<i data-lucide="loader-2" class="w-4 h-4 animate-spin mr-2"></i>Ex√©cution...';
            lucide.createIcons();

            try {
                console.log('üåê Envoi de la requ√™te...');
                const response = await fetch('{% url "exercises:submit" exercise.id %}', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': getCookie('csrftoken')
                    },
                    body: JSON.stringify({ code })
                });

                const data = await response.json();
                console.log('üì° R√©ponse re√ßue:', response.status, data);

                if (response.ok) {
                    updateTestsDisplay(data.test_results);
                    showResults(data.success ? 'success' : 'failed', data);

                    // ‚úÖ AJOUT DYNAMIQUE si r√©ussite
                    if (data.success) {
                        // Badge "Compl√©t√©"
                        const badgeContainer = document.querySelector('.flex.items-center.space-x-2');
                        const alreadyCompleted = badgeContainer.querySelector('.text-primary-green');

                        if (!alreadyCompleted) {
                            const badge = document.createElement('span');
                            badge.className = "px-3 py-1 bg-primary-green/20 text-primary-green rounded-full text-sm font-medium flex items-center space-x-1";
                            badge.innerHTML = `<i data-lucide="check" class="w-3 h-3"></i><span>Compl√©t√©</span>`;
                            badgeContainer.appendChild(badge);
                            lucide.createIcons();
                            console.log('‚úÖ Badge Compl√©t√© ajout√©');
                        }

                        // Tentative r√©cente
                        const historySection = document.querySelector('.space-y-2');
                        if (historySection) {
                showResults(data.success ? 'success' : 'failed', data);
                            attempt.className = 'bg-gray-900 rounded-lg p-3 border border-gray-600 flex items-center justify-between';

                            attempt.innerHTML = `
                                <div class="flex items-center space-x-3">
                                    <i data-lucide="check-circle" class="w-4 h-4 text-green-400"></i>
                                    <span class="text-green-400 text-sm">R√©ussi</span>
                                    <span class="text-gray-400 text-sm">${data.test_results.length}/${data.test_results.length} tests</span>
                                </div>
                                <span class="text-gray-500 text-xs">√† l‚Äôinstant</span>
                            `;
                            historySection.prepend(attempt);
                            lucide.createIcons();
                            console.log('üìä Tentative ajout√©e');
                        }
                    }

                    // XP comme avant
                    if (data.success && data.xp_result) {
                        setTimeout(() => {
                            if (typeof showXPGain === 'function') {
                                showXPGain(
                                    data.xp_result.xp_gained,
                                    'exercise_completion',
                                    data.xp_result.level_up,
                                    data.xp_result.new_level || null
                                );
                            }
                        }, 1000);
                    }
                } else {
                    showResults('error', data.error || 'Erreur inconnue.');
                }
            } catch (error) {
                console.error('‚ùå Erreur:', error);
                showResults('error', 'Erreur de connexion. Veuillez r√©essayer.');
            } finally {
                runBtn.disabled = false;
                runBtn.innerHTML = originalContent;
                lucide.createIcons();
            }
        });
    });

    // üéØ Fonction pour r√©initialiser l'affichage des tests
    function resetTestsDisplay() {
        document.querySelectorAll('.test-case').forEach(testCase => {
            testCase.classList.remove('test-passed', 'test-failed', 'test-running');
            const status = testCase.querySelector('.test-status');
            const result = testCase.querySelector('.test-result');
            
            if (status) {
                status.className = 'test-status w-6 h-6 rounded-full bg-gray-600 flex items-center justify-center';
                status.innerHTML = `<span class="text-xs font-bold text-gray-400">${testCase.dataset.testIndex ? parseInt(testCase.dataset.testIndex) + 1 : '?'}</span>`;
            }
            
            if (result) {
                result.classList.add('hidden');
            }
        });
    }

    // üéØ Animation des r√©sultats test par test
    async function animateTestResults(testResults) {
        for (let i = 0; i < testResults.length; i++) {
            const testCase = document.querySelector(`[data-test-index="${i}"]`);
            const result = testResults[i];
            
            if (!testCase) continue;
            
            // üîÑ Marquer comme en cours
            testCase.classList.add('test-running');
            const status = testCase.querySelector('.test-status');
            if (status) {
                status.className = 'test-status w-6 h-6 rounded-full bg-blue-500 flex items-center justify-center animate-pulse';
                status.innerHTML = '<i data-lucide="loader-2" class="w-3 h-3 text-white animate-spin"></i>';
                lucide.createIcons();
            }
            
            // ‚è±Ô∏è Attendre un peu pour l'effet visuel
            await new Promise(resolve => setTimeout(resolve, 500));
            
            // ‚úÖ ou ‚ùå Afficher le r√©sultat
            testCase.classList.remove('test-running');
            
            if (result.passed) {
                testCase.classList.add('test-passed');
                if (status) {
                    status.className = 'test-status w-6 h-6 rounded-full bg-green-500 flex items-center justify-center';
                    status.innerHTML = '<i data-lucide="check" class="w-3 h-3 text-white"></i>';
                }
                
                // üéâ Animation de succ√®s
                testCase.style.transform = 'scale(1.05)';
                setTimeout(() => {
                    testCase.style.transform = 'scale(1)';
                }, 200);
                
        if (status === 'running') {
            resultsContent.innerHTML = `
                <div class="flex items-center space-x-3 p-4 bg-blue-500/10 border border-blue-500/30 rounded-lg">
                    <i data-lucide="loader-2" class="w-5 h-5 text-blue-400 animate-spin"></i>
                    <span class="text-blue-400 font-medium">${data.message}</span>
                </div>
            `;
            lucide.createIcons();
            return;
        }
        
            } else {
            const passedTests = data.passed_tests || 0;
            const totalTests = data.total_tests || 0;
            const points = data.xp_result ? data.xp_result.xp_gained : 20;
            
                testCase.classList.add('test-failed');
                <div class="space-y-4">
                    <div class="flex items-center space-x-3 p-4 bg-green-500/10 border border-green-500/30 rounded-lg">
                        <i data-lucide="trophy" class="w-6 h-6 text-yellow-400"></i>
                        <div>
                            <div class="text-green-400 font-bold text-lg">üéâ Exercice r√©ussi !</div>
                            <div class="text-green-300 text-sm">Tous les tests sont pass√©s (${passedTests}/${totalTests})</div>
                        </div>
                    </div>
                    
                    <div class="grid grid-cols-2 gap-4">
                        <div class="p-3 bg-yellow-500/10 border border-yellow-500/30 rounded-lg text-center">
                            <div class="text-yellow-400 font-bold text-xl">+${points}</div>
                            <div class="text-yellow-300 text-xs">Points XP</div>
                        </div>
                        <div class="p-3 bg-blue-500/10 border border-blue-500/30 rounded-lg text-center">
                            <div class="text-blue-400 font-bold text-xl">${(data.execution_time * 1000).toFixed(0)}ms</div>
                            <div class="text-blue-300 text-xs">Temps d'ex√©cution</div>
                        </div>
                    </div>
                }
                
                // üìä Afficher le r√©sultat obtenu
            const passedTests = data.passed_tests || 0;
            const totalTests = data.total_tests || 0;
            
                const resultDiv = testCase.querySelector('.test-result');
                <div class="space-y-4">
                    <div class="flex items-center space-x-3 p-4 bg-red-500/10 border border-red-500/30 rounded-lg">
                        <i data-lucide="x-circle" class="w-5 h-5 text-red-400"></i>
                        <div>
                            <div class="text-red-400 font-bold">Tests √©chou√©s</div>
                            <div class="text-red-300 text-sm">${passedTests}/${totalTests} tests r√©ussis</div>
                        </div>
                    </div>
                    
                    <div class="p-3 bg-gray-800 rounded-lg">
                        <div class="text-gray-300 text-sm">üí° <strong>Conseil :</strong> V√©rifiez votre code et r√©essayez !</div>
                    </div>
                    if (actualCode) {
                        actualCode.textContent = result.actual || 'Aucune sortie';
                    }
                }
            }
            
            lucide.createIcons();
            
            // ‚è±Ô∏è Petit d√©lai entre chaque test
            if (i < testResults.length - 1) {
                await new Promise(resolve => setTimeout(resolve, 300));
            }
        }
    }
    // üîê R√©cup√©ration du token CSRF
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }
});
</script>


<style>
/* Styles pour l'√©diteur Monaco */
.monaco-editor {
    border-radius: 0 !important;
}

    function showResults(status, data) {
#code-editor {
    font-family: 'JetBrains Mono', 'Fira Code', 'SF Mono', Monaco, 'Cascadia Code', monospace !important;
    font-size: 14px !important;
    line-height: 1.8 !important;
    color: #e6edf3 !important;
    background-color: #0d1117 !important;
    border: 1px solid #30363d !important;
    border-radius: 6px !important;
    padding: 16px !important;
    tab-size: 4 !important;
    white-space: pre !important;
    overflow: hidden; !important;
}

#code-editor:focus {
    outline: none !important;
    border-color: #4CAF50 !important;
    box-shadow: 0 0 0 2px rgba(76, 175, 80, 0.2) !important;
}

.monaco-editor .margin {
    background-color: #1e1e1e !important;
}

.monaco-editor .monaco-editor-background {
    background-color: #1e1e1e !important;
}

/* Styles pour les tests */
.test-case {
    position: relative;
    overflow: hidden;
}

.test-case::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    height: 2px;
    background: linear-gradient(90deg, transparent, rgba(76, 175, 80, 0.3), transparent);
    opacity: 0;
    transition: opacity 0.3s ease;
}

.test-case.test-passed::before {
    background: linear-gradient(90deg, transparent, rgba(34, 197, 94, 0.6), transparent);
    opacity: 1;
}

.test-case.test-failed::before {
    background: linear-gradient(90deg, transparent, rgba(239, 68, 68, 0.6), transparent);
    opacity: 1;
}

/* Animation de succ√®s */
.test-case.test-passed {
    border-color: #22C55E;
    background-color: rgba(34, 197, 94, 0.05);
}

.test-case.test-failed {
    border-color: #EF4444;
    background-color: rgba(239, 68, 68, 0.05);
}
/* Styles pour les r√©sultats */
#results-panel {
    max-height: 350px;
    overflow-y: auto;
    border-top: 2px solid #374151;
}

/* Animation pour les r√©sultats */
#results-panel {
    animation: slideUp 0.3s ease-out;
}

@keyframes slideUp {
    from {
        transform: translateY(20px);
        opacity: 0;
    }
    to {
        transform: translateY(0);
        opacity: 1;
    }
}

/* Scrollbar pour les r√©sultats */
#results-panel::-webkit-scrollbar {
    width: 6px;
}

#results-panel::-webkit-scrollbar-track {
    background: #1F2937;
}

#results-panel::-webkit-scrollbar-thumb {
    background: #4B5563;
    border-radius: 3px;
}

#results-panel::-webkit-scrollbar-thumb:hover {
    background: #6B7280;
}
</style>
{% endblock %}