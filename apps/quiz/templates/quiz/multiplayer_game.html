{% extends 'base.html' %}

{% block title %}Multiplayer Quiz - Room {{ room.code }}{% endblock %}

{% block extra_head %}
<!-- Prism.js for syntax highlighting -->
<link href="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/themes/prism-tomorrow.min.css" rel="stylesheet" />
<script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/prism-core.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/plugins/autoloader/prism-autoloader.min.js"></script>
<script>
  Prism.plugins.autoloader.languages_path = 'https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/';
</script>
{% endblock %}

{% block content %}
<div class="p-6 h-full flex flex-col overflow-hidden">
    <!-- Game Header -->
    <div class="flex items-center justify-between mb-6 flex-shrink-0">
        <div class="flex items-center space-x-3">
            <i data-lucide="users" class="w-6 h-6 text-purple-500"></i>
            <div>
                <h1 class="text-xl font-bold text-white">{{ room.topic }}</h1>
                <p class="text-sm text-gray-400">Room {{ room.code }} - Multiplayer Mode</p>
            </div>
        </div>
        
        <div class="flex items-center space-x-4">
            <div class="flex items-center space-x-2">
                <i data-lucide="clock" class="w-5 h-5 text-primary-blue"></i>
                <span class="text-primary-blue font-mono text-lg" id="timer">60s</span>
            </div>
            <div class="text-white">
                Question <span id="current-question">1</span> of <span id="total-questions">{{ room.num_questions }}</span>
            </div>
        </div>
    </div>

    <!-- Main Quiz Area -->
    <div class="flex-1 flex flex-col min-h-0 space-y-6">
        <!-- Question Block -->
        <div class="bg-gray-800 rounded-lg border border-gray-700 flex flex-col min-h-0">
            <!-- Progress bar -->
            <div class="p-4 border-b border-gray-700 flex-shrink-0">
                <div class="w-full bg-gray-700 rounded-full h-2">
                    <div id="progress-bar" class="bg-primary-green h-2 rounded-full transition-all duration-300" style="width: 0%"></div>
                </div>
            </div>
            
            <!-- Question content - scrollable if needed -->
            <div class="flex-1 overflow-y-auto min-h-0 question-scroll-container">
                <div class="p-6">
                    <div id="question-text" class="text-white space-y-4 text-base">
                        <div class="text-center py-12">
                            <div class="w-16 h-16 bg-purple-500/20 rounded-full flex items-center justify-center mx-auto mb-4">
                                <i data-lucide="loader-2" class="w-8 h-8 text-purple-500 animate-spin"></i>
                            </div>
                            <h2 class="text-xl font-bold text-white mb-2">Loading question...</h2>
                            <p class="text-gray-400">Please wait while we load the first question</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Options - always visible at bottom -->
            <div class="p-4 pt-3 border-t border-gray-700 flex-shrink-0">
                <div class="space-y-2" id="options-container">
                    <!-- Dynamically generated options -->
                </div>
            </div>
        </div>

        <!-- Leaderboard -->
        <div class="bg-gray-800 rounded-lg p-4 border border-gray-700 flex-shrink-0">
            <h3 class="text-base font-bold text-white mb-3 flex items-center space-x-2">
                <i data-lucide="trophy" class="w-5 h-5 text-yellow-500"></i>
                <span>Live Leaderboard</span>
            </h3>
            <div id="leaderboard-content">
                <div class="text-center text-gray-400">Loading players...</div>
            </div>
        </div>
    </div>

    <!-- Footer -->
    <div class="flex justify-between items-center mt-6 flex-shrink-0">
        <a href="{% url 'quiz:room_detail' room.code %}" class="px-4 py-2 text-sm bg-gray-700 text-white rounded-lg hover:bg-gray-600 transition-colors">
            Back to Room
        </a>
        <div class="text-sm text-white font-semibold">
            Your Score: <span id="my-score">0</span>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function () {
    lucide.createIcons();

    let currentQuestionNumber = 1;
    let totalQuestions = {{ room.num_questions }};
    let timeLeft = 60;
    let timer = null;
    let userAnswered = false;
    let gameFinished = false;
    let myScore = 0;

    // Start the game loop
    loadCurrentQuestion();
    
    // Update leaderboard every 2 seconds
    setInterval(updateLeaderboard, 2000);

    function loadCurrentQuestion() {
        console.log('üîÑ Loading question...');
        
        fetch(`/quiz/api/room/{{ room.code }}/quiz/`)
            .then(response => {
                console.log('üì° Response status:', response.status);
                return response.json();
            })
            .then(data => {
                console.log('üìä Question data received:', data);
                
                if (data.error) {
                    showError(data.error);
                    return;
                }
                
                if (data.room_status === 'finished') {
                    showFinalResults();
                    return;
                }
                
                if (data.question) {
                    showQuestion(data.question);
                    userAnswered = data.has_answered || false;
                    
                    if (!userAnswered && !gameFinished) {
                        startTimer();
                    } else if (userAnswered) {
                        showWaitingForOthers();
                    }
                }
            })
            .catch(err => {
                console.error('‚ùå Question load error:', err);
                showError('Failed to load question. Retrying...');
                setTimeout(loadCurrentQuestion, 3000);
            });
    }

    function showQuestion(question) {
        console.log('üìù Showing question:', question.number);
        
        currentQuestionNumber = question.number;
        document.getElementById('current-question').textContent = currentQuestionNumber;
        
        // Format question text with code blocks
        const formattedQuestion = question.text.replace(/```(\w+)?\n?([\s\S]*?)```/g, function (match, lang, code) {
            const language = lang || 'code';
            const displayLang = language === 'python' ? 'Python' : language.charAt(0).toUpperCase() + language.slice(1);
            return `<div class="code-block-container my-4">
                <div class="code-header">
                    <span class="code-language">${displayLang}</span>
                </div>
                <pre class="code-content language-${language}"><code class="language-${language}">${code.trim()}</code></pre>
            </div>`;
        });
        
        document.getElementById('question-text').innerHTML = formattedQuestion;
        
        // Update progress bar
        const progressPercent = (currentQuestionNumber / totalQuestions) * 100;
        document.getElementById('progress-bar').style.width = progressPercent + '%';

        // Generate options
        const optionsContainer = document.getElementById('options-container');
        optionsContainer.innerHTML = '';

        question.options.forEach((option, index) => {
            const button = document.createElement('button');
            button.className = 'quiz-option w-full p-4 text-left bg-gray-900 border border-gray-600 rounded-lg text-white hover:border-primary-green hover:bg-gray-800 transition-all duration-200 transform hover:scale-[1.01]';
            button.setAttribute('data-answer', index);
            button.innerHTML = `
                <div class="flex items-center space-x-3">
                    <div class="w-6 h-6 bg-gray-700 rounded-full flex items-center justify-center text-xs font-bold">
                        ${String.fromCharCode(65 + index)}
                    </div>
                    <span class="text-sm">${option}</span>
                </div>
            `;
            
            // Add click event listener
            button.addEventListener('click', function() {
                console.log('üñ±Ô∏è Button clicked, answer:', index);
                submitAnswer(index);
            });
            
            optionsContainer.appendChild(button);
        });
        
        // Reinitialize Prism highlighting
        if (window.Prism) {
            setTimeout(() => Prism.highlightAll(), 100);
        }
        
        lucide.createIcons();
    }

    function startTimer() {
        timeLeft = 60;
        updateTimerDisplay();
        
        timer = setInterval(() => {
            timeLeft--;
            updateTimerDisplay();

            if (timeLeft <= 0) {
                clearInterval(timer);
                if (!userAnswered) {
                    console.log('‚è∞ Time up, auto-submitting...');
                    submitAnswer(-1); // No answer
                }
            }
        }, 1000);
    }
    
    function updateTimerDisplay() {
        const timerEl = document.getElementById('timer');
        if (timerEl) {
            timerEl.textContent = timeLeft + 's';
            if (timeLeft <= 10) {
                timerEl.classList.add('text-red-500');
                timerEl.classList.remove('text-primary-blue');
            } else {
                timerEl.classList.add('text-primary-blue');
                timerEl.classList.remove('text-red-500');
            }
        }
    }

    function submitAnswer(answerIndex) {
        if (userAnswered) {
            console.log('‚ö†Ô∏è Already answered, ignoring click');
            return;
        }
        
        console.log('üì§ Submitting answer:', answerIndex);
        userAnswered = true;
        clearInterval(timer);
        
        // Visual feedback
        const buttons = document.querySelectorAll('.quiz-option');
        buttons.forEach((btn, index) => {
            btn.disabled = true;
            btn.classList.add('opacity-50', 'cursor-not-allowed');
            btn.style.pointerEvents = 'none';
            
            if (index === answerIndex && answerIndex >= 0) {
                btn.classList.add('border-blue-500', 'bg-blue-500/20');
            }
        });
        
        const responseTime = 60 - timeLeft;
        
        fetch(`/quiz/api/room/{{ room.code }}/quiz/`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken')
            },
            body: JSON.stringify({
                answer: answerIndex,
                response_time: responseTime
            })
        })
        .then(response => {
            console.log('üì° Submit response status:', response.status);
            return response.json();
        })
        .then(data => {
            console.log('üìä Submit response data:', data);
            
            if (data.error) {
                console.error('‚ùå Submit error:', data.error);
                showError(data.error);
                return;
            }
            
            // Update my score
            myScore = data.new_score || 0;
            document.getElementById('my-score').textContent = myScore;
            
            // Show correct answer
            showCorrectAnswer(data);
            
            // Wait for next question or end
            setTimeout(() => {
                if (currentQuestionNumber < totalQuestions) {
                    userAnswered = false;
                    loadCurrentQuestion();
                } else {
                    showFinalResults();
                }
            }, 4000);
        })
        .catch(err => {
            console.error('‚ùå Submit error:', err);
            showError('Failed to submit answer. Please try again.');
            
            // Re-enable buttons on error
            const buttons = document.querySelectorAll('.quiz-option');
            buttons.forEach(btn => {
                btn.disabled = false;
                btn.classList.remove('opacity-50', 'cursor-not-allowed');
                btn.style.pointerEvents = 'auto';
            });
            userAnswered = false;
        });
    }

    function showCorrectAnswer(data) {
        // Sauvegarder la position de scroll avant modification
        const questionContainer = document.querySelector('.question-scroll-container');
        const scrollPosition = questionContainer ? questionContainer.scrollTop : 0;
        
        const buttons = document.querySelectorAll('.quiz-option');
        
        buttons.forEach((button, index) => {
            if (index === data.correct_answer) {
                button.classList.remove('border-gray-600', 'border-blue-500', 'bg-blue-500/20');
                button.classList.add('border-green-500', 'bg-green-500/20');
            } else {
                button.classList.add('opacity-60');
            }
        });
        
        // Show points and explanation
        const optionsContainer = document.getElementById('options-container');
        const resultDiv = document.createElement('div');
        resultDiv.className = 'mt-4 space-y-3';
        
        // Points earned
        const pointsDiv = document.createElement('div');
        pointsDiv.className = 'p-4 bg-blue-500/10 border border-blue-500/30 rounded-lg';
        pointsDiv.innerHTML = `
            <div class="flex items-center justify-center space-x-3">
                <i data-lucide="zap" class="w-5 h-5 text-yellow-400"></i>
                <span class="text-white font-bold">+${data.points || 0} points!</span>
                <span class="text-gray-400">Total: ${data.new_score || 0}</span>
            </div>
        `;
        resultDiv.appendChild(pointsDiv);
        
        // Explanation if available
        if (data.explanation) {
            const explanationDiv = document.createElement('div');
            explanationDiv.className = 'p-4 bg-gray-900 border border-gray-600 rounded-lg';
            explanationDiv.innerHTML = `
                <div class="flex items-start space-x-3">
                    <i data-lucide="lightbulb" class="w-5 h-5 text-blue-400 mt-0.5 flex-shrink-0"></i>
                    <div>
                        <h4 class="text-sm font-bold text-blue-400 mb-2">Explanation</h4>
                        <p class="text-sm text-blue-200">${data.explanation}</p>
                    </div>
                </div>
            `;
            resultDiv.appendChild(explanationDiv);
        }
        
        optionsContainer.appendChild(resultDiv);
        lucide.createIcons();
        
        // Restaurer la position de scroll apr√®s modification
        if (questionContainer) {
            questionContainer.scrollTop = scrollPosition;
        }
    }
    
    function showWaitingForOthers() {
        const optionsContainer = document.getElementById('options-container');
        optionsContainer.innerHTML = `
            <div class="text-center py-8">
                <div class="w-12 h-12 bg-yellow-500/20 rounded-full flex items-center justify-center mx-auto mb-4">
                    <i data-lucide="clock" class="w-6 h-6 text-yellow-500"></i>
                </div>
                <h3 class="text-lg font-bold text-white mb-2">Answer submitted!</h3>
                <p class="text-gray-400">Waiting for other players...</p>
            </div>
        `;
        lucide.createIcons();
    }
    
    function updateLeaderboard() {
        fetch(`/quiz/api/room/{{ room.code }}/status/`)
            .then(response => response.json())
            .then(data => {
                if (data.participants) {
                    const leaderboard = document.getElementById('leaderboard-content');
                    
                    leaderboard.innerHTML = data.participants.map((p, index) => `
                        <div class="flex items-center justify-between p-2 bg-gray-900 rounded-lg mb-1">
                            <div class="flex items-center space-x-3">
                                <div class="text-sm font-bold ${index === 0 ? 'text-yellow-500' : index === 1 ? 'text-gray-300' : index === 2 ? 'text-orange-500' : 'text-gray-400'}">
                                    #${index + 1}
                                </div>
                                <img src="${p.avatar_url || '/static/koda/koda_base.png'}" alt="Avatar" class="w-6 h-6 rounded-full object-cover">
                                <span class="text-white font-medium text-sm">${p.username}</span>
                                ${p.is_host ? '<i data-lucide="crown" class="w-4 h-4 text-yellow-500"></i>' : ''}
                            </div>
                            <div class="text-right">
                                <div class="text-white font-bold text-sm">${p.score}</div>
                                <div class="text-xs text-gray-400">${p.correct_answers} correct</div>
                            </div>
                        </div>
                    `).join('');
                    
                    lucide.createIcons();
                }
                
                // Check if game finished
                if (data.status === 'finished' && !gameFinished) {
                    gameFinished = true;
                    showFinalResults();
                }
            })
            .catch(err => console.log('Leaderboard update error:', err));
    }
    
    function showFinalResults() {
        gameFinished = true;
        clearInterval(timer);
        
        document.getElementById('question-text').innerHTML = `
            <div class="text-center py-12">
                <div class="w-16 h-16 bg-yellow-500/20 rounded-full flex items-center justify-center mx-auto mb-4">
                    <i data-lucide="trophy" class="w-8 h-8 text-yellow-500"></i>
                </div>
                <h2 class="text-2xl font-bold text-white mb-2">Game Finished!</h2>
                <p class="text-gray-400 mb-6">Check the final leaderboard below</p>
                <div class="space-x-4">
                    <a href="/quiz/lobby/" class="px-6 py-3 bg-purple-500 text-white rounded-lg hover:bg-purple-600 transition-colors inline-flex items-center space-x-2">
                        <i data-lucide="home" class="w-4 h-4"></i>
                        <span>Back to Lobby</span>
                    </a>
                    <a href="/quiz/create/" class="px-6 py-3 bg-green-500 text-white rounded-lg hover:bg-green-600 transition-colors inline-flex items-center space-x-2">
                        <i data-lucide="plus" class="w-4 h-4"></i>
                        <span>New Game</span>
                    </a>
                </div>
            </div>
        `;
        
        document.getElementById('options-container').innerHTML = '';
        lucide.createIcons();
    }
    
    function showError(message) {
        document.getElementById('question-text').innerHTML = `
            <div class="text-center py-8">
                <div class="w-12 h-12 bg-red-500/20 rounded-full flex items-center justify-center mx-auto mb-4">
                    <i data-lucide="alert-circle" class="w-6 h-6 text-red-500"></i>
                </div>
                <h3 class="text-lg font-bold text-white mb-2">Error</h3>
                <p class="text-red-400">${message}</p>
            </div>
        `;
        lucide.createIcons();
    }
    
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }
});
</script>

<style>
/* Scrollbar pour la zone de question */
.overflow-y-auto {
    scrollbar-width: thin;
    scrollbar-color: #4B5563 #1F2937;
}

.overflow-y-auto::-webkit-scrollbar {
    width: 6px;
}

.overflow-y-auto::-webkit-scrollbar-track {
    background: #1F2937;
    border-radius: 3px;
}

.overflow-y-auto::-webkit-scrollbar-thumb {
    background: #4B5563;
    border-radius: 3px;
}

.overflow-y-auto::-webkit-scrollbar-thumb:hover {
    background: #6B7280;
}

/* Code blocks styling */
.code-block-container {
    background: #0D1117;
    border: 1px solid #30363D;
    border-radius: 0.5rem;
    overflow: hidden;
    margin: 1rem 0;
}

.code-header {
    background: #21262D;
    padding: 0.75rem 1rem;
    border-bottom: 1px solid #30363D;
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.code-language {
    font-size: 0.75rem;
    color: #7C3AED;
    background: #1E1B4B;
    padding: 0.25rem 0.5rem;
    border-radius: 0.25rem;
    font-family: 'SF Mono', Monaco, 'Cascadia Code', monospace;
    font-weight: 600;
}

.code-content {
    padding: 1rem !important;
    margin: 0 !important;
    background: #0D1117;
    color: #E6EDF3;
    font-family: 'SF Mono', Monaco, 'Cascadia Code', monospace;
    font-size: 0.875rem !important;
    line-height: 1.4 !important;
    overflow-x: auto;
}

/* Quiz options styling */
.quiz-option {
    transition: all 0.2s ease !important;
    cursor: pointer !important;
}

.quiz-option:hover:not(:disabled) {
    transform: translateY(-1px) !important;
    box-shadow: 0 4px 12px rgba(76, 175, 80, 0.2) !important;
}

.quiz-option:active:not(:disabled) {
    transform: translateY(0) !important;
}

.quiz-option:disabled {
    cursor: not-allowed !important;
}

/* Remove Prism automatic labels */
code[class^="language-"]::before,
pre[class^="language-"]::before,
code[class*=" language-"]::before,
pre[class*=" language-"]::before {
    content: none !important;
    display: none !important;
}
</style>
{% endblock %}