<!-- Tab Bar Component - Exact KodaTheme Design with Dynamic Behavior -->
<div class="h-10 bg-gray-800 border-b border-gray-700 flex items-center">
    <div class="flex" id="tabs-container">
        <!-- Les onglets seront ajoutés dynamiquement ici -->
    </div>
</div>

<script>
// Gestion dynamique des onglets avec ordre chronologique
let openTabsOrder = []; // Array pour maintenir l'ordre d'ouverture

// Configuration des onglets disponibles
const availableTabs = {
    'courses': {
        title: 'Générateur de Cours',
        url: "{% url 'courses:generator' %}"
    },
    'chat': {
        title: 'Recherche IA',
        url: "{% url 'chat:search' %}"
    },
    'quiz': {
        title: 'Quiz & QCM',
        url: "{% url 'quiz:lobby' %}"
    },
    'tracker': {
        title: 'Performances',
        url: "{% url 'tracker:dashboard' %}"
    },
    'revision': {
        title: 'Révision',
        url: "{% url 'revision:flashcards' %}"
    }
};

// Détecter l'onglet actuel basé sur l'URL
function getCurrentTab() {
    const path = window.location.pathname;
    if (path.includes('courses')) return 'courses';
    if (path.includes('chat')) return 'chat';
    if (path.includes('quiz')) return 'quiz';
    if (path.includes('tracker')) return 'tracker';
    if (path.includes('revision')) return 'revision';
    return 'courses'; // par défaut
}

// Ajouter un onglet dans l'ordre chronologique
function addTab(tabId) {
    if (!availableTabs[tabId]) return;
    
    // Si l'onglet n'est pas déjà ouvert, l'ajouter à la fin
    if (!openTabsOrder.includes(tabId)) {
        openTabsOrder.push(tabId);
        renderTabs();
        saveTabsToStorage();
    }
}

// Fermer un onglet
function closeTab(event, tabId) {
    event.stopPropagation();
    
    // Retirer l'onglet de la liste ordonnée
    const index = openTabsOrder.indexOf(tabId);
    if (index > -1) {
        openTabsOrder.splice(index, 1);
    }
    
    // Si on ferme l'onglet actuel et qu'il y en a d'autres, aller au premier
    const currentTab = getCurrentTab();
    if (tabId === currentTab && openTabsOrder.length > 0) {
        const firstTab = openTabsOrder[0];
        window.location.href = availableTabs[firstTab].url;
    } else if (openTabsOrder.length === 0) {
        // Si plus d'onglets, aller à l'accueil
        window.location.href = "{% url 'courses:generator' %}";
    } else {
        renderTabs();
        saveTabsToStorage();
    }
}

// Naviguer vers un onglet
function navigateToTab(tabId) {
    window.location.href = availableTabs[tabId].url;
}

// Rendre les onglets dans l'ordre chronologique
function renderTabs() {
    const container = document.getElementById('tabs-container');
    const currentTab = getCurrentTab();
    
    container.innerHTML = '';
    
    // Afficher les onglets dans l'ordre chronologique d'ouverture
    openTabsOrder.forEach(tabId => {
        const tab = availableTabs[tabId];
        if (!tab) return; // Sécurité
        
        const isActive = tabId === currentTab;
        
        const tabElement = document.createElement('div');
        tabElement.className = `h-10 px-4 flex items-center text-sm border-r border-gray-700 cursor-pointer transition-colors duration-150 group relative ${
            isActive ? 'bg-gray-900 text-white' : 'bg-gray-800 text-gray-300 hover:bg-gray-750'
        }`;
        
        tabElement.innerHTML = `
            <span class="mr-2 truncate max-w-32">${tab.title}</span>
            <button class="opacity-0 group-hover:opacity-100 transition-opacity duration-150 p-1 hover:bg-gray-600 rounded" onclick="closeTab(event, '${tabId}')">
                <i data-lucide="x" class="w-3 h-3"></i>
            </button>
        `;
        
        tabElement.addEventListener('click', () => navigateToTab(tabId));
        container.appendChild(tabElement);
    });
    
    // Réinitialiser les icônes Lucide
    if (typeof lucide !== 'undefined') {
        lucide.createIcons();
    }
}

// Sauvegarder l'ordre des onglets
function saveTabsToStorage() {
    localStorage.setItem('openTabsOrder', JSON.stringify(openTabsOrder));
}

// Charger l'ordre des onglets
function loadTabsFromStorage() {
    const savedTabs = localStorage.getItem('openTabsOrder');
    if (savedTabs) {
        try {
            const tabsArray = JSON.parse(savedTabs);
            // Vérifier que tous les onglets existent encore
            openTabsOrder = tabsArray.filter(tabId => availableTabs[tabId]);
        } catch (e) {
            console.log('Erreur lors du chargement des onglets sauvegardés');
            openTabsOrder = [];
        }
    }
}

// Initialiser au chargement de la page
document.addEventListener('DOMContentLoaded', function() {
    // Charger les onglets sauvegardés
    loadTabsFromStorage();
    
    // Ajouter l'onglet actuel s'il n'est pas déjà dans la liste
    const currentTab = getCurrentTab();
    if (!openTabsOrder.includes(currentTab)) {
        openTabsOrder.push(currentTab);
    }
    
    renderTabs();
});

// Sauvegarder les onglets ouverts avant de quitter
window.addEventListener('beforeunload', function() {
    saveTabsToStorage();
});

// Fonction globale pour ouvrir un onglet depuis la sidebar
window.openTab = function(tabId) {
    addTab(tabId);
    navigateToTab(tabId);
};
</script>