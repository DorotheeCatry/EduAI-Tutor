<script>
// Gestion simplifiée des onglets
let openTabs = new Set(); // Utiliser un Set pour éviter les doublons

// Configuration des onglets disponibles
const availableTabs = {
    'profile': {
        title: 'Profile',
        url: "/auth/profile/"
    },
    'courses': {
        title: 'Course Generator',
        url: "/courses/generator/"
    },
    'my-courses': {
        title: 'My Courses',
        url: "/courses/my-courses/"
    },
    'chat': {
        title: 'AI Search',
        url: "/chat/search/"
    },
    'quiz': {
        title: 'Quiz & MCQ',
        url: "/quiz/lobby/"
    },
    'exercises': {
        title: 'Python Exercises',
        url: "/exercises/"
    },
    'tracker': {
        title: 'Performance',
        url: "/tracker/dashboard/"
    },
    'revision': {
        title: 'Revision',
        url: "/revision/flashcards/"
    }
};

// Détecter l'onglet actuel basé sur l'URL
function getCurrentTab() {
    const path = window.location.pathname;
    if (path.includes('/auth/profile')) return 'profile';
    if (path.includes('/courses/my-courses')) return 'my-courses';
    if (path.includes('/courses/generator') || path.includes('/courses/detail')) return 'courses';
    if (path.includes('chat')) return 'chat';
    if (path.includes('quiz')) return 'quiz';
    if (path.includes('exercises')) return 'exercises';
    if (path.includes('tracker')) return 'tracker';
    if (path.includes('revision')) return 'revision';
    return null;
}

// Ajouter un onglet
function addTab(tabId) {
    if (!availableTabs[tabId]) return;
    openTabs.add(tabId);
    renderTabs();
    saveTabsToStorage();
}

// Fermer un onglet
function closeTab(event, tabId) {
    event.stopPropagation();
    openTabs.delete(tabId);
    
    // Si on ferme l'onglet actuel et qu'il y en a d'autres, aller au premier
    const currentTab = getCurrentTab();
    if (tabId === currentTab && openTabs.size > 0) {
        const firstTab = Array.from(openTabs)[0];
        window.location.href = availableTabs[firstTab].url;
    } else if (openTabs.size === 0) {
        // Si plus d'onglets, aller à l'accueil
        window.location.href = "/courses/generator/";
    } else {
        renderTabs();
        saveTabsToStorage();
    }
}

// Naviguer vers un onglet
function navigateToTab(tabId) {
    window.location.href = availableTabs[tabId].url;
}

// Rendre les onglets
function renderTabs() {
    const container = document.getElementById('tabs-container');
    const currentTab = getCurrentTab();
    
    if (!container) return;
    
    // Toujours ajouter l'onglet actuel s'il existe
    if (currentTab && availableTabs[currentTab]) {
        openTabs.add(currentTab);
    }
    
    container.innerHTML = '';
    
    // Ordre fixe des onglets pour plus de stabilité
    const tabOrder = ['courses', 'my-courses', 'chat', 'quiz', 'exercises', 'tracker', 'revision', 'profile'];
    
    tabOrder.forEach(tabId => {
        if (!openTabs.has(tabId)) return;
        
        const tab = availableTabs[tabId];
        if (!tab) return;
        
        const isActive = tabId === currentTab;
        
        const tabElement = document.createElement('div');
        tabElement.className = `px-3 py-1 text-sm cursor-pointer transition-colors duration-150 group relative rounded flex items-center space-x-2 ${
            isActive ? 'bg-primary-green text-white' : 'bg-gray-700 text-gray-300 hover:bg-gray-600'
        }`;
        
        tabElement.innerHTML = `
            <span class="truncate max-w-32">${tab.title}</span>
            <button class="opacity-0 group-hover:opacity-100 transition-opacity duration-150 ml-2 hover:bg-gray-600 rounded p-1" onclick="closeTab(event, '${tabId}')">
                <i data-lucide="x" class="w-3 h-3"></i>
            </button>
        `;
        
        tabElement.addEventListener('click', () => navigateToTab(tabId));
        container.appendChild(tabElement);
    });
    
    // Réinitialiser les icônes Lucide
    if (typeof lucide !== 'undefined') {
        lucide.createIcons();
    }
}

// Sauvegarder l'ordre des onglets
function saveTabsToStorage() {
    localStorage.setItem('openTabs', JSON.stringify(Array.from(openTabs)));
}

// Charger l'ordre des onglets
function loadTabsFromStorage() {
    const savedTabs = localStorage.getItem('openTabs');
    if (savedTabs) {
        try {
            const tabsArray = JSON.parse(savedTabs);
            openTabs = new Set(tabsArray.filter(tabId => availableTabs[tabId]));
        } catch (e) {
            console.log('Erreur lors du chargement des onglets sauvegardés');
            openTabs = new Set();
        }
    }
}

// Initialiser au chargement de la page
document.addEventListener('DOMContentLoaded', function() {
    // Charger les onglets sauvegardés
    loadTabsFromStorage();
    
    // Toujours ajouter l'onglet actuel
    const currentTab = getCurrentTab();
    if (currentTab) {
        openTabs.add(currentTab);
    }
    
    renderTabs();
});

// Sauvegarder les onglets ouverts avant de quitter
window.addEventListener('beforeunload', function() {
    saveTabsToStorage();
});

// Fonction globale pour ouvrir un onglet depuis la sidebar
window.openTab = function(tabId) {
    openTabs.add(tabId);
    saveTabsToStorage();
    navigateToTab(tabId);
};
</script>