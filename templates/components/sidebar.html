{% load static %}

<!-- Sidebar Component - KodaTheme avec Profil en haut -->
<div class="w-16 bg-gray-900 border-r border-gray-700 flex flex-col items-center py-4 space-y-2 shadow-xl flex-shrink-0">
    <!-- Logo -->
    <div class="mb-6">
        <i data-lucide="code" class="w-8 h-8 text-primary-green"></i>
    </div>

    <!-- Navigation Items -->
    <nav class="flex flex-col space-y-2 flex-1">
        <!-- Bouton Profil -->
        <div class="relative z-[9999]">
            <button onclick="toggleProfileMenu()" 
                    id="profile-button"
                    title="Profil"
                    class="w-12 h-12 rounded-lg flex items-center justify-center transition-all duration-200 relative flex-shrink-0
                           {% if 'profile' in request.path %}bg-green-500/20 text-green-500 border border-green-500/30 shadow-lg{% else %}text-gray-400 hover:text-white hover:bg-gray-800{% endif %}">
                {% if user.avatar %}
                    {% if user.avatar.url %}
                        <img src="{{ user.avatar.url }}" alt="Avatar" class="w-10 h-10 rounded-full object-cover border-2 border-gray-600" style="object-position: center top;">
                    {% else %}
                        <img src="{% static 'koda/' %}{{ user.avatar }}" alt="Avatar" class="w-10 h-10 rounded-full object-cover border-2 border-gray-600" style="object-position: center top;">
                    {% endif %}
                {% else %}
                    <img src="{% static 'koda/koda_base.png' %}" alt="Avatar par défaut" class="w-10 h-10 rounded-full object-cover border-2 border-gray-600" style="object-position: center top;">
                {% endif %}
            </button>

            <!-- Menu déroulant du profil -->
            <div id="profile-menu" class="absolute left-16 top-0 w-64 bg-gray-800 border border-gray-600 rounded-lg shadow-2xl hidden" style="z-index: 99999 !important;">
                <!-- Flèche pointant vers le bouton -->
                <div class="absolute -left-2 top-6 w-4 h-4 bg-gray-800 border-l border-t border-gray-600 transform rotate-45"></div>
                
                <!-- Header du menu -->
                <div class="p-3 border-b border-gray-600 bg-gray-800 rounded-t-lg">
                    <div class="flex items-center space-x-3">
                        {% if user.avatar %}
                            {% if user.avatar.url %}
                                <img src="{{ user.avatar.url }}" alt="Avatar" class="w-8 h-8 rounded-full object-cover" style="object-position: center top;">
                            {% else %}
                                <img src="{% static 'koda/' %}{{ user.avatar }}" alt="Avatar" class="w-8 h-8 rounded-full object-cover" style="object-position: center top;">
                            {% endif %}
                        {% else %}
                            <img src="{% static 'koda/koda_base.png' %}" alt="Avatar par défaut" class="w-8 h-8 rounded-full object-cover" style="object-position: center top;">
                        {% endif %}
                        <div>
                            <div class="text-sm font-medium text-white">{{ user.username }}</div>
                        </div>
                    </div>
                </div>

                <!-- Liens d'action -->
                <div class="py-1 bg-gray-800 rounded-b-lg">
                    <!-- Bouton Edit Profile -->
                    <button onclick="openTab('profile')" class="w-full flex items-center px-3 py-2 text-sm text-gray-300 hover:bg-gray-700 hover:text-white transition-all duration-200 text-left">
                        <i data-lucide="user" class="w-4 h-4 mr-2"></i>
                        <span>Edit Profile</span>
                    </button>

                    <!-- Form Logout -->
                    <form method="post" action="{% url 'users:logout' %}" class="m-0">
                        {% csrf_token %}
                        <button type="submit" class="w-full flex items-center px-3 py-2 text-sm text-gray-300 hover:bg-red-600 hover:text-red-400 transition-all duration-200 text-left">
                            <i data-lucide="log-out" class="w-4 h-4 mr-2"></i>
                            <span>Sign Out</span>
                        </button>
                    </form>
                </div>
            </div>
        </div>

        <!-- Autres boutons -->
        <button onclick="openTab('courses')" title="Cours"
                class="w-12 h-12 rounded-lg flex items-center justify-center transition-all duration-200 relative flex-shrink-0
                    {% if request.path == '/courses/generator/' %}bg-green-500/20 text-green-500 border border-green-500/30 shadow-lg{% else %}text-gray-400 hover:text-white hover:bg-gray-800/50{% endif %}">
            <i data-lucide="book-open" class="w-5 h-5 relative z-10"></i>
        </button>

        <button onclick="openTab('my-courses')" title="Mes Cours"
                class="w-12 h-12 rounded-lg flex items-center justify-center transition-all duration-200 relative flex-shrink-0
                    {% if request.path == '/courses/my-courses/' %}bg-green-500/20 text-green-500 border border-green-500/30 shadow-lg{% else %}text-gray-400 hover:text-white hover:bg-gray-800/50{% endif %}">
            <i data-lucide="bookmark" class="w-5 h-5 relative z-10"></i>
        </button>

        <button onclick="openTab('chat')" title="Recherche"
                class="w-12 h-12 rounded-lg flex items-center justify-center transition-all duration-200 relative flex-shrink-0
                       {% if 'chat' in request.path %}bg-green-500/20 text-green-500 border border-green-500/30 shadow-lg{% else %}text-gray-400 hover:text-white hover:bg-gray-800/50{% endif %}">
            <i data-lucide="search" class="w-5 h-5 relative z-10"></i>
        </button>

        <button onclick="openTab('exercises')" title="Exercices Python"
                class="w-12 h-12 rounded-lg flex items-center justify-center transition-all duration-200 relative flex-shrink-0
                       {% if 'exercises' in request.path %}bg-green-500/20 text-green-500 border border-green-500/30 shadow-lg{% else %}text-gray-400 hover:text-white hover:bg-gray-800/50{% endif %}">
            <i data-lucide="code" class="w-5 h-5 relative z-10"></i>
        </button>

        <button onclick="openTab('quiz')" title="Quiz"
                class="w-12 h-12 rounded-lg flex items-center justify-center transition-all duration-200 relative flex-shrink-0
                       {% if 'quiz' in request.path %}bg-green-500/20 text-green-500 border border-green-500/30 shadow-lg{% else %}text-gray-400 hover:text-white hover:bg-gray-800/50{% endif %}">
            <i data-lucide="brain" class="w-5 h-5 relative z-10"></i>
        </button>

        <button onclick="openTab('revision')" title="Révision"
                class="w-12 h-12 rounded-lg flex items-center justify-center transition-all duration-200 relative flex-shrink-0
                       {% if 'revision' in request.path %}bg-green-500/20 text-green-500 border border-green-500/30 shadow-lg{% else %}text-gray-400 hover:text-white hover:bg-gray-800/50{% endif %}">
            <i data-lucide="rotate-ccw" class="w-5 h-5 relative z-10"></i>
        </button>

        <button onclick="openTab('tracker')" title="Performances"
                class="w-12 h-12 rounded-lg flex items-center justify-center transition-all duration-200 relative flex-shrink-0
                       {% if 'tracker' in request.path %}bg-green-500/20 text-green-500 border border-green-500/30 shadow-lg{% else %}text-gray-400 hover:text-white hover:bg-gray-800/50{% endif %}">
            <i data-lucide="bar-chart-3" class="w-5 h-5 relative z-10"></i>
        </button>


    </nav>
</div>

<!-- JS -->
<script>
function toggleProfileMenu() {
    const menu = document.getElementById('profile-menu');
    if (menu) {
        menu.classList.toggle('hidden');
    }
}

document.addEventListener('click', function(event) {
    const profileButton = document.getElementById('profile-button');
    const profileMenu = document.getElementById('profile-menu');
    
    if (profileButton && profileMenu && !profileButton.contains(event.target) && !profileMenu.contains(event.target)) {
        profileMenu.classList.add('hidden');
    }
});

document.addEventListener("DOMContentLoaded", function () {
    if (window.lucide) {
        lucide.createIcons();
    }
});

// Fonction globale pour ouvrir un onglet depuis la sidebar
window.openTab = function(tabId) {
    const urls = {
        'profile': '/auth/profile/',
        'courses': '/courses/generator/',
        'my-courses': '/courses/my-courses/',
        'chat': '/chat/search/',
        'quiz': '/quiz/lobby/',
        'exercises': '/exercises/',
        'tracker': '/tracker/dashboard/',
        'revision': '/revision/flashcards/',
    };
    
    if (urls[tabId]) {
        window.location.href = urls[tabId];
    }
};
</script>